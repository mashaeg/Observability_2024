# CMS Server Installation and Configuration Guide

## System Requirements
- Ubuntu 22.04 LTS
- RAM: 2GB minimum
- CPU: 1 core minimum
- Storage: 20GB minimum
- Access to ELK server IP address

## 1. Initial Server Setup

### Create Admin User
```bash
# Create user and add to sudo group
sudo adduser --ingroup sudo admin

## 2. LEMP Stack Installation

```bash
# Update system
apt update
apt upgrade -y

# Install NGINX, MySQL, PHP-FPM and required PHP modules
apt install -y nginx \
    mysql-server \
    php-fpm \
    php-mysql \
    php-curl \
    php-gd \
    php-intl \
    php-mbstring \
    php-soap \
    php-xml \
    php-xmlrpc \
    php-zip

# Verify installations
nginx -v
mysql --version
php-fpm8.1 -v
```

## 3. MySQL Configuration

```bash
# Secure MySQL installation
mysql_secure_installation

# Access MySQL
mysql -u root -p

# Create database and user
CREATE DATABASE cmsdb;
CREATE USER 'cmsuser'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON cmsdb.* TO 'cmsuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# Test new user access
mysql -u cmsuser -p cmsdb
```

## 4. NGINX Configuration

```bash
# Backup default configuration
cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup

# Create new configuration
nano /etc/nginx/sites-available/default
```

Add this configuration:
```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/html;
    index index.php index.html index.htm;
    server_name _;

    # Metrics endpoint for Metricbeat
    location /nginx_status {
        stub_status on;
        allow 127.0.0.1;        # Allow localhost
        deny all;               # Deny all other hosts
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP-FPM Configuration
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    }

    # Deny access to .htaccess files
    location ~ /\.ht {
        deny all;
    }

    # Enhanced logging format
    access_log /var/log/nginx/access.log combined buffer=512k flush=1m;
    error_log /var/log/nginx/error.log;
}
```

```bash
# Test NGINX configuration
nginx -t

# Restart NGINX if test is successful
systemctl restart nginx
```

## 5. PHP-FPM Configuration

```bash
# Configure PHP
nano /etc/php/8.1/fpm/php.ini
```

Update these values:
```ini
upload_max_filesize = 64M
post_max_size = 64M
max_execution_time = 300
memory_limit = 256M
```

```bash
# Restart PHP-FPM
systemctl restart php8.1-fpm
```

## 8. Start and Enable Services

```bash
# Enable and start all services
systemctl enable nginx mysql php8.1-fpm filebeat metricbeat
systemctl start nginx mysql php8.1-fpm filebeat metricbeat

# Verify services are running
systemctl status nginx
systemctl status mysql
systemctl status php8.1-fpm
systemctl status filebeat
systemctl status metricbeat
```
# Verification Steps

### Test NGINX
```bash
# Check NGINX status
curl localhost

# Check NGINX metrics endpoint
curl localhost/nginx_status
```

### Test PHP
```bash
# Create PHP info file
echo "<?php phpinfo(); ?>" > /var/www/html/info.php

# Access in browser or curl
curl localhost/info.php
```

### Test MySQL
```bash
# Check MySQL connection
mysql -u cmsuser -p -e "SHOW DATABASES;"
```

### Test Beats
```bash
# Test Filebeat configuration
filebeat test config

# Test Filebeat connection
filebeat test output

# Test Metricbeat configuration
metricbeat test config

# Test Metricbeat connection
metricbeat test output
```

## Troubleshooting

### NGINX Issues
```bash
# Check error logs
tail -f /var/log/nginx/error.log

# Check access logs
tail -f /var/log/nginx/access.log

# Test configuration
nginx -t
```

### PHP-FPM Issues
```bash
# Check PHP-FPM logs
tail -f /var/log/php8.1-fpm.log

# Check PHP-FPM status
systemctl status php8.1-fpm
```

### MySQL Issues
```bash
# Check MySQL logs
tail -f /var/log/mysql/error.log

# Check MySQL status
systemctl status mysql

# Check MySQL processes
ps aux | grep mysql
```

### Beats Issues
```bash
# Check Filebeat logs
journalctl -u filebeat

# Check Metricbeat logs
journalctl -u metricbeat

# Test connection to ELK server
curl ELK_SERVER_IP:9200
```