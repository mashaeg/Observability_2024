# Setting up Filebeat for NGINX, MySQL, and PHP-FPM Logs

This guide walks you through setting up Filebeat to collect and forward logs from NGINX, MySQL, and PHP-FPM to Elasticsearch.

## Prerequisites

- Ubuntu 22.04 or similar Linux distribution
- Root or sudo access
- NGINX, MySQL, and PHP-FPM installed and running
- Elasticsearch server running (in this guide, we assume it's at 10.114.0.3:9200)

## Installation Steps

### 1. Install Filebeat

```bash
# Update package list
sudo apt-get update

# Install Filebeat
sudo apt-get install filebeat
```

### 2. Configure Filebeat

Create a new configuration file:

```bash
sudo tee /etc/filebeat/filebeat.yml > /dev/null << 'EOF'
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  fields:
    log_type: nginx
  fields_under_root: true
  processors:
    - dissect:
        tokenizer: "%{client_ip} - %{user} [%{timestamp}] \"%{method} %{request} HTTP/%{httpversion}\" %{status_code} %{size} \"%{referrer}\" \"%{agent}\""
        field: "message"
        target_prefix: "nginx"

- type: log
  enabled: true
  paths:
    - /var/log/mysql/error.log
  fields:
    log_type: mysql
  fields_under_root: true

- type: log
  enabled: true
  paths:
    - /var/log/php8.3-fpm.log
  fields:
    log_type: php-fpm
  fields_under_root: true

output.elasticsearch:
  hosts: ["10.114.0.3:9200"]
  index: "%{[log_type]}-logs-%{+yyyy.MM.dd}"

setup.template.enabled: true
setup.template.name: "logs"
setup.template.pattern: "*-logs-*"

path.data: /var/lib/filebeat
path.logs: /var/log/filebeat

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
EOF
```

### 3. Set Up Directory Structure and Permissions

```bash
# Create necessary directories
sudo mkdir -p /var/lib/filebeat/registry/filebeat
sudo mkdir -p /var/log/filebeat

# Set proper permissions
sudo chown -R root:root /var/lib/filebeat
sudo chmod -R 0755 /var/lib/filebeat
```

### 4. Initialize Registry Files

```bash
# Create meta.json
sudo tee /var/lib/filebeat/registry/filebeat/meta.json > /dev/null << 'EOF'
{
    "version": "0",
    "codec": "2"
}
EOF

# Create data.json
sudo tee /var/lib/filebeat/registry/filebeat/data.json > /dev/null << 'EOF'
[]
EOF

# Set proper permissions
sudo chmod 0644 /var/lib/filebeat/registry/filebeat/meta.json
sudo chmod 0644 /var/lib/filebeat/registry/filebeat/data.json
```

### 5. Verify Log File Permissions

Make sure Filebeat can read the log files:

```bash
# Check log file permissions
ls -l /var/log/nginx/access.log
ls -l /var/log/mysql/error.log
ls -l /var/log/php8.3-fpm.log
```

The files should be readable by the root user (as Filebeat runs as root).

### 6. Test Configuration

```bash
# Test the configuration
sudo filebeat test config -c /etc/filebeat/filebeat.yml

# Test the Elasticsearch connection
sudo filebeat test output
```

### 7. Start Filebeat Service

```bash
# Enable and start Filebeat
sudo systemctl enable filebeat
sudo systemctl start filebeat

# Check status
sudo systemctl status filebeat
```

### 8. Verify Log Collection

Generate test logs:

```bash
# NGINX test
curl "http://localhost/test-$(date +%s)"

# PHP-FPM test
sudo systemctl restart php8.3-fpm

# MySQL test
mysql -e "SHOW VARIABLES LIKE 'version';" 2>/dev/null
```

Check logs in Elasticsearch:

```bash
# Check recent logs
curl -X GET "10.114.0.3:9200/*-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "sort": [{"@timestamp": "desc"}],
  "size": 3,
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-1m"
      }
    }
  }
}'
```

## Troubleshooting

### Common Issues and Solutions

1. **Lock File Error**
   ```bash
   sudo systemctl stop filebeat
   sudo rm /var/lib/filebeat/filebeat.lock
   sudo systemctl start filebeat
   ```

2. **Registry Issues**
   ```bash
   sudo systemctl stop filebeat
   sudo rm -rf /var/lib/filebeat/registry
   # Then follow steps 3 and 4 again
   ```

3. **Permission Issues**
   ```bash
   sudo chown -R root:root /var/lib/filebeat
   sudo chmod -R 0755 /var/lib/filebeat
   sudo chmod 0644 /var/lib/filebeat/registry/filebeat/*.json
   ```

### Debug Mode

For troubleshooting, you can run Filebeat in debug mode:

```bash
sudo filebeat -e -c /etc/filebeat/filebeat.yml -d "publish*"
```

## Maintenance

### Log Rotation

Set up log rotation to manage log file sizes:

```bash
sudo tee /etc/logrotate.d/app-logs << 'EOF'
/var/log/nginx/access.log
/var/log/mysql/error.log
/var/log/php8.1-fpm.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    sharedscripts
    postrotate
        /bin/systemctl reload nginx
        /bin/systemctl reload mysql
        /bin/systemctl reload php8.3-fpm
    endscript
}
EOF
```

### Monitoring

Monitor Filebeat's performance:

```bash
# Check Filebeat logs
sudo journalctl -u filebeat -f

# Check Filebeat status
sudo systemctl status filebeat
```

## Useful Commands

```bash
# View live logs
sudo tail -f /var/log/filebeat/filebeat*

# Check Elasticsearch indices
curl -X GET "10.114.0.3:9200/_cat/indices/*-logs-*?v"

# Reset Filebeat (if needed)
sudo systemctl stop filebeat
sudo rm -rf /var/lib/filebeat/registry/*
sudo systemctl start filebeat
```
