# 6. Kibana Guide

## Initial Setup

### 1. Create Index Patterns
1. Navigate to **Stack Management â†’ Index Patterns**
2. Create three patterns:
```
nginx-logs-*     (for NGINX logs)
mysql-logs-*     (for MySQL logs)
metricbeat-*     (for all metrics)
```

### 2. Essential Dashboards to Create

## A. System Overview Dashboard

1. Create New Dashboard:
   - Go to **Dashboard â†’ Create dashboard**
   - Click **Create visualization**

2. Add CPU Usage Panel:
```json
{
  "type": "metric",
  "query": {
    "field": "system.cpu.user.pct",
    "aggregation": "avg"
  },
  "visualization": {
    "title": "CPU Usage",
    "type": "gauge",
    "params": {
      "ranges": [
        { "to": 60, "color": "green" },
        { "from": 60, "to": 85, "color": "yellow" },
        { "from": 85, "color": "red" }
      ]
    }
  }
}
```

3. Add Memory Usage Panel:
```json
{
  "type": "metric",
  "query": {
    "field": "system.memory.used.pct",
    "aggregation": "avg"
  },
  "visualization": {
    "title": "Memory Usage",
    "type": "gauge",
    "params": {
      "ranges": [
        { "to": 75, "color": "green" },
        { "from": 75, "to": 90, "color": "yellow" },
        { "from": 90, "color": "red" }
      ]
    }
  }
}
```

## B. NGINX Monitoring Dashboard

1. Request Rate Panel:
```json
{
  "type": "line",
  "query": {
    "field": "nginx.stubstatus.requests",
    "aggregation": "rate"
  },
  "visualization": {
    "title": "Requests per Second",
    "params": {
      "timeRange": {
        "interval": "1m"
      }
    }
  }
}
```

2. HTTP Status Codes:
```json
{
  "type": "pie",
  "query": {
    "field": "nginx.status_code",
    "aggregation": "terms"
  },
  "visualization": {
    "title": "HTTP Status Distribution",
    "params": {
      "donut": true,
      "labels": {
        "show": true,
        "values": true,
        "lastLevel": true
      }
    }
  }
}
```

3. Top URIs:
```json
{
  "type": "table",
  "query": {
    "field": "nginx.request",
    "aggregation": "terms",
    "size": 10
  },
  "visualization": {
    "title": "Most Requested URIs",
    "params": {
      "perPage": 10,
      "showMetricsAtAllLevels": false
    }
  }
}
```

## C. MySQL Performance Dashboard

1. Connections Overview:
```json
{
  "type": "metric",
  "query": [
    {
      "field": "mysql.status.threads.connected",
      "aggregation": "max"
    },
    {
      "field": "mysql.status.threads.running",
      "aggregation": "max"
    }
  ],
  "visualization": {
    "title": "Active Connections"
  }
}
```

2. Query Rate:
```json
{
  "type": "line",
  "query": {
    "field": "mysql.status.queries",
    "aggregation": "rate"
  },
  "visualization": {
    "title": "Queries per Second"
  }
}
```

## Setting Up Alerts

### 1. High CPU Usage Alert
```yaml
name: "High CPU Alert"
type: "threshold"
conditions:
  - when: system.cpu.user.pct
    exceeds: 80
    for: "5m"
actions:
  - notify:
      message: "CPU usage exceeded 80% for 5 minutes"
```

### 2. Error Rate Alert
```yaml
name: "High Error Rate"
type: "threshold"
conditions:
  - when: nginx.status_code
    matches: ">=500"
    count: ">10"
    over: "5m"
actions:
  - notify:
      message: "High rate of 5xx errors detected"
```

## Useful Searches

### NGINX Error Investigation
```kibana
nginx.status_code:>=500 AND nginx.request:*
```

### Slow Queries
```kibana
metricset.name:mysql AND mysql.slowlog.query_time_sec > 1
```

## Example Dashboard Layouts

### 1. System Overview
```
+------------------------+------------------------+
|       CPU Usage        |     Memory Usage      |
+------------------------+------------------------+
|                                               |
|           System Load Average                 |
|                                               |
+------------------------+------------------------+
|    Disk I/O            |    Network Traffic   |
+------------------------+------------------------+
```

### 2. NGINX Dashboard
```
+------------------------+------------------------+
|    Requests/Second     |   Active Connections  |
+------------------------+------------------------+
|                                               |
|           Status Code Distribution            |
|                                               |
+------------------------+------------------------+
|         Top 10 URLs    |    Response Times    |
+------------------------+------------------------+
```

### 3. MySQL Dashboard
```
+------------------------+------------------------+
|   Active Connections   |    Queries/Second     |
+------------------------+------------------------+
|                                               |
|              InnoDB Buffer Stats              |
|                                               |
+------------------------+------------------------+
|    Table Operations    |    Query Statistics   |
+------------------------+------------------------+
```

## Common Visualizations and Their KQLs

### 1. Error Rate Tracking
```kibana
nginx.status_code:>=400 | stats count() by nginx.status_code
```

### 2. Resource Usage
```kibana
metricset.name:system and metricset.module:system | stats avg(system.cpu.user.pct) by host.name
```

### 3. Slow Requests
```kibana
nginx.request_time > 1 | stats count() by nginx.request
```