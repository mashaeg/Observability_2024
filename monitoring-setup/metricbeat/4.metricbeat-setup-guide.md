# Metricbeat Setup Guide
This guide explains how to set up comprehensive monitoring for a LEMP stack (Linux, NGINX, MySQL, PHP) using Filebeat and Metricbeat.

## Prerequisites
- Ubuntu 22.04 LTS
- NGINX installed and running
- MySQL installed and running
- PHP-FPM installed and running
- Access to Elasticsearch server (in this guide: 10.114.0.3:9200)

## Part 1: Metricbeat Setup (Performance Metrics)

### 1.1. Install Metricbeat
```bash
# Download and install Metricbeat
curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.15.3-amd64.deb
sudo dpkg -i metricbeat-8.15.3-amd64.deb
```

### 1.2. Configure MySQL User for Monitoring
```bash
# Create MySQL monitoring user
sudo mysql -e "
DROP USER IF EXISTS 'metricbeat'@'localhost';
CREATE USER 'metricbeat'@'localhost' IDENTIFIED WITH mysql_native_password BY 'MetricBeat123!@#';
GRANT SELECT, PROCESS ON *.* TO 'metricbeat'@'localhost';
FLUSH PRIVILEGES;"
```

### 1.3. Configure NGINX Status Module
```bash
# Add NGINX status configuration
sudo tee /etc/nginx/conf.d/status.conf > /dev/null << 'EOF'
server {
    listen 127.0.0.1:80;
    server_name localhost;

    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
EOF

# Test and reload NGINX
sudo nginx -t
sudo systemctl reload nginx
```

### 2.4. Configure Metricbeat
```bash
sudo tee /etc/metricbeat/metricbeat.yml > /dev/null << 'EOF'
metricbeat.modules:
- module: system
  metricsets:
    - cpu
    - load
    - memory
    - network
    - process
  enabled: true
  period: 10s

- module: nginx
  metricsets: ["stubstatus"]
  enabled: true
  period: 10s
  hosts: ["http://localhost/nginx_status"]

- module: mysql
  metricsets: ["status", "performance"]
  enabled: true
  period: 10s
  hosts: ["tcp(localhost:3306)/"]
  username: metricbeat
  password: "MetricBeat123!@#"  # MySQL User for Monitoring password, you created earlier

output.elasticsearch:
  hosts: ["10.114.0.3:9200"]
  index: "metricbeat-%{[agent.version]}-%{+yyyy.MM.dd}"

setup.template.enabled: true
setup.template.name: "metricbeat"
setup.template.pattern: "metricbeat-*"
setup.template.settings:
  index.number_of_shards: 1
  index.number_of_replicas: 1

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/metricbeat
  name: metricbeat
  keepfiles: 7
  permissions: 0644
EOF
```

## Part 3: Start and Verify Services

### 3.1. Start Services
```bash
# Enable and start both services
sudo systemctl enable metricbeat
sudo systemctl start  metricbeat

# Check status
sudo systemctl status metricbeat
```

### 3.2. Verify Data Collection

#### Check Metricbeat logs:
```bash
# Test configuration
sudo metricbeat test config
sudo metricbeat test output

# Check logs
sudo tail -f /var/log/metricbeat/metricbeat
```

### 3.3. Verify Data in Elasticsearch

Check Filebeat indices:
```bash
curl -X GET "10.114.0.3:9200/*-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-1m"
      }
    }
  },
  "size": 1
}'
```

Check Metricbeat indices:
```bash
curl -X GET "10.114.0.3:9200/metricbeat-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-1m"
      }
    }
  },
  "size": 1
}'
```

## Part 4: Troubleshooting

### Common Issues and Solutions

#### Filebeat Issues
1. If Filebeat won't start due to lock file:
```bash
sudo systemctl stop filebeat
sudo rm /var/lib/filebeat/filebeat.lock
sudo systemctl start filebeat
```

2. If logs aren't being collected, reset registry:
```bash
sudo systemctl stop filebeat
sudo rm -rf /var/lib/filebeat/registry/*
# Follow section 1.3 to reinitialize registry
sudo systemctl start filebeat
```

#### Metricbeat Issues
1. MySQL connection issues:
```bash
# Verify MySQL user
mysql -u metricbeat -p'MetricBeat123!@#' -e "SHOW GLOBAL STATUS;"
```

2. NGINX status issues:
```bash
# Test NGINX status endpoint
curl http://localhost/nginx_status
```

### Verify Permissions
```bash
# Check log file permissions
ls -l /var/log/nginx/access.log
ls -l /var/log/mysql/error.log
ls -l /var/log/php8.1-fpm.log
```

## Understanding the Setup

### What Gets Monitored
- **Filebeat collects**:
  - NGINX access logs (requests, responses)
  - MySQL error logs
  - PHP-FPM logs

- **Metricbeat collects**:
  - System metrics (CPU, memory, network)
  - NGINX metrics (connections, requests)
  - MySQL metrics (queries, performance, status)

### Where to Find the Data
- Logs: `http://10.114.0.3:9200/*-logs-*`
- Metrics: `http://10.114.0.3:9200/metricbeat-*`

### Directory Setup
```bash
# Create necessary directories
sudo mkdir -p /var/log/metricbeat
sudo chown -R root:root /var/log/metricbeat
sudo chmod 755 /var/log/metricbeat
```

### Module Configuration Verification
```bash
# Enable and configure modules
sudo metricbeat modules enable system
sudo metricbeat modules enable nginx
sudo metricbeat modules enable mysql

# List enabled modules
sudo metricbeat modules list
```

### Test Configuration
```bash
# Test configuration
sudo metricbeat test config

# Test output connection
sudo metricbeat test output

# Load index template
sudo metricbeat setup --index-management

# Load Kibana dashboards
sudo metricbeat setup --dashboards
```

### Service Management
```bash
# Start and enable Metricbeat
sudo systemctl enable metricbeat
sudo systemctl start metricbeat

# Check status
sudo systemctl status metricbeat
```

### Verify Metrics Collection

#### System Metrics
```bash
# Check if system metrics are being collected
curl -X GET "10.114.0.3:9200/metricbeat-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "event.module": "system" } },
        { "range": { "@timestamp": { "gte": "now-1m" } } }
      ]
    }
  },
  "size": 1
}'
```

#### NGINX Metrics
```bash
# Verify NGINX metrics
curl -X GET "10.114.0.3:9200/metricbeat-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "event.module": "nginx" } },
        { "range": { "@timestamp": { "gte": "now-1m" } } }
      ]
    }
  },
  "size": 1
}'
```

#### MySQL Metrics
```bash
# Verify MySQL metrics
curl -X GET "10.114.0.3:9200/metricbeat-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "event.module": "mysql" } },
        { "range": { "@timestamp": { "gte": "now-1m" } } }
      ]
    }
  },
  "size": 1
}'
```

### Troubleshooting

#### Service Issues
```bash
# Check Metricbeat logs
sudo journalctl -u metricbeat -f

# Check Metricbeat process
ps aux | grep metricbeat
```

#### Module Issues
```bash
# Test modules individually
sudo metricbeat test modules system
sudo metricbeat test modules nginx
sudo metricbeat test modules mysql
```

#### NGINX Status Issues
```bash
# Test NGINX status endpoint
curl http://localhost/nginx_status

# Check NGINX error logs
sudo tail -f /var/log/nginx/error.log
```

#### MySQL Connection Issues
```bash
# Test MySQL user access
mysql -u metricbeat -p -e "SHOW PROCESSLIST"

# Check MySQL error log
sudo tail -f /var/log/mysql/error.log
```

#### Reset Metricbeat
```bash
# If needed, reset Metricbeat
sudo systemctl stop metricbeat
sudo rm -rf /var/lib/metricbeat/registry
sudo systemctl start metricbeat
```

#### Monitor Metricbeat Internal Metrics
```bash
# Check internal metrics
curl -XGET 'http://localhost:5066/stats' -H 'Content-Type: application/json'
```

### Maintenance

#### Log Rotation
```bash
# Configure log rotation for Metricbeat
sudo tee /etc/logrotate.d/metricbeat << 'EOF'
/var/log/metricbeat/metricbeat* {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    postrotate
        systemctl restart metricbeat
    endscript
}
EOF
```