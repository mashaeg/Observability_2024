# 5. Kibana Guide
This guide explains how to view and analyze your monitoring data in Kibana.

## Accessing Kibana
1. Open your web browser
2. Navigate to `http://10.114.0.3:5601` or your public_ip

## Part 1: Logs Visualization (Filebeat)

### 1.1. View NGINX Access Logs
1. Go to **Analytics → Discover**
2. Create a new index pattern:
   - Click **Create index pattern**
   - Enter `nginx-logs-*`
   - Select `@timestamp` as time field
   - Click **Create index pattern**

3. Useful fields to add to your view:
   - `nginx.client_ip` (Client IP addresses)
   - `nginx.method` (HTTP methods)
   - `nginx.status_code` (HTTP response codes)
   - `nginx.request` (Requested URLs)
   - `nginx.agent` (User agents)

### 1.2. Create NGINX Dashboard
1. Go to **Analytics → Dashboard**
2. Click **Create dashboard**
3. Add these visualizations:

#### HTTP Status Codes Pie Chart
- Select **Create Visualization**
- Choose **Pie**
- Select your NGINX index
- Metrics: **Count**
- Buckets: Split slices → **nginx.status_code**

#### Top URLs Bar Chart
- Create new visualization
- Choose **Horizontal bar**
- Metrics: **Count**
- Buckets: **nginx.request** (top 10)

#### Traffic Over Time
- Choose **Line**
- Y-axis: **Count**
- X-axis: **@timestamp** (Hourly)

## Part 2: Metrics Visualization (Metricbeat)

### 2.1. System Metrics
1. Go to **Analytics → Discover**
2. Create index pattern: `metricbeat-*`
3. Important metrics to monitor:

#### CPU Usage Dashboard
```yaml
Visualizations:
- Title: CPU Usage
  Type: Gauge
  Field: system.cpu.user.pct
  Thresholds:
    - 0 to 60: Green
    - 60 to 85: Yellow
    - 85 to 100: Red

- Title: CPU Load Over Time
  Type: Line
  Y-axis: system.cpu.user.pct
  X-axis: @timestamp
```

#### Memory Usage Dashboard
```yaml
Visualizations:
- Title: Memory Usage
  Type: Gauge
  Field: system.memory.used.pct
  
- Title: Memory Timeline
  Type: Area
  Fields:
    - system.memory.total
    - system.memory.used.bytes
    - system.memory.free
```

### 2.2. NGINX Metrics Dashboard
Create visualizations for:
```yaml
- Active Connections:
  Type: Metric
  Field: nginx.stubstatus.active

- Request Rate:
  Type: Line
  Field: nginx.stubstatus.requests
  Aggregation: Rate

- Connection Status:
  Type: Split Gauge
  Fields:
    - nginx.stubstatus.reading
    - nginx.stubstatus.writing
    - nginx.stubstatus.waiting
```

### 2.3. MySQL Metrics Dashboard
```yaml
Visualizations:
- Title: MySQL Connections
  Type: Metric
  Fields:
    - mysql.status.threads.connected
    - mysql.status.threads.running

- Title: Query Statistics
  Type: Line
  Fields:
    - mysql.status.queries
    - mysql.status.questions
    
- Title: InnoDB Buffer Pool
  Type: Gauge
  Fields:
    - mysql.status.innodb.buffer_pool.pages.total
    - mysql.status.innodb.buffer_pool.pages.free
```

## Part 3: Setting Up Alerts

### 3.1. CPU Alert
1. Go to **Security → Rules**
2. Create rule:
```yaml
Name: High CPU Usage
Trigger:
  - WHEN: system.cpu.user.pct > 80
  - FOR: 5 minutes
Action: Send notification
```

### 3.2. Memory Alert
```yaml
Name: High Memory Usage
Trigger:
  - WHEN: system.memory.used.pct > 90
  - FOR: 5 minutes
Action: Send notification
```

### 3.3. NGINX Error Alert
```yaml
Name: High Error Rate
Trigger:
  - WHEN: nginx status_code >= 500
  - Count: > 10 in 5 minutes
Action: Send notification
```

## Part 4: Useful Saved Searches

### 4.1. Error Tracking
```yaml
NGINX 500 Errors:
  Query: nginx.status_code:>=500

PHP-FPM Errors:
  Query: message:*error* OR message:*fatal*

MySQL Errors:
  Query: log_type:mysql AND message:*error*
```

### 4.2. Performance Monitoring
```yaml
Slow NGINX Responses:
  Query: nginx.request_time:>1

High MySQL Connections:
  Query: mysql.status.threads.connected:>100
```

## Part 5: Creating Custom Dashboards

### 5.1. Overall System Health Dashboard
Combine:
- System metrics (CPU, Memory, Disk)
- NGINX active connections
- MySQL active connections
- Error rates from all services

### 5.2. NGINX Performance Dashboard
Include:
- Request rate
- Response times
- Status codes
- Top URLs
- User agents
- Geographic distribution (if available)