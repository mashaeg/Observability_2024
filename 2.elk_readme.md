# Complete ELK Stack and CMS Server Setup Guide

## Infrastructure Requirements

### CMS Server
- OS: Ubuntu 22.04 LTS
- RAM: 2GB minimum
- CPU: 1 core minimum
- Storage: 20GB minimum

### ELK Server
- OS: Ubuntu 22.04 LTS
- RAM: 4GB minimum
- CPU: 2 cores minimum
- Storage: 30GB minimum

## Initial Setup for Both Servers

1. Create a sudo user:
```bash
# Create user and add to sudo group
sudo adduser --ingroup sudo admin

# Copy SSH keys (if using)
sudo mkdir -p /home/admin/.ssh
sudo cp /root/.ssh/authorized_keys /home/admin/.ssh/
sudo chown -R admin:sudo /home/admin/.ssh
sudo chmod 700 /home/admin/.ssh
sudo chmod 600 /home/admin/.ssh/authorized_keys
```

## ELK Server Setup

### 1. Install Elasticsearch

```bash
# Install Java
apt update
apt install -y openjdk-11-jdk

# Install Elasticsearch
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
apt update
apt install -y elasticsearch=8.15.3

# Verify Java installation
java -version
```

### 2. Configure Elasticsearch

Create/edit `/etc/elasticsearch/elasticsearch.yml`:
```yaml
# Basic settings
cluster.name: elasticsearch
node.name: node-1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 127.0.0.1
http.port: 9200
discovery.type: single-node

# Disable security features for development
xpack.security.enabled: false
xpack.security.enrollment.enabled: false
xpack.security.http.ssl.enabled: false
xpack.security.transport.ssl.enabled: false
```

Set permissions and start service:
```bash
# Set permissions
chown -R elasticsearch:elasticsearch /var/lib/elasticsearch
chown -R elasticsearch:elasticsearch /var/log/elasticsearch
chown -R elasticsearch:elasticsearch /etc/elasticsearch

# Start service
systemctl daemon-reload
systemctl enable elasticsearch
systemctl start elasticsearch

# Verify Elasticsearch is running
curl localhost:9200
systemctl status elasticsearch
```

### 3. Install and Configure Kibana

```bash
# Install Kibana
apt install -y kibana=8.15.3
```

Configure Kibana in `/etc/kibana/kibana.yml`:
```yaml
# Server settings
server.host: "0.0.0.0"
server.port: 5601

# Elasticsearch connection
elasticsearch.hosts: ["http://localhost:9200"]

# Security settings
elasticsearch.username: "kibana_system"
xpack.security.enabled: false

# Logging
logging.root.level: "info"
```

Create Kibana service in `/etc/systemd/system/kibana.service`:
```ini
[Unit]
Description=Kibana
After=elasticsearch.service

[Service]
Type=simple
User=kibana
Group=kibana
Environment=NODE_OPTIONS="--max-old-space-size=512"
ExecStart=/usr/share/kibana/bin/kibana serve
Restart=always
WorkingDirectory=/usr/share/kibana

[Install]
WantedBy=multi-user.target
```

Set permissions and start service:
```bash
# Set ownership
chown -R kibana:kibana /usr/share/kibana
chown -R kibana:kibana /etc/kibana

# Create and set run directory
mkdir -p /var/run/kibana
chown -R kibana:kibana /var/run/kibana
chmod -R 755 /var/run/kibana

# Start service
systemctl daemon-reload
systemctl enable kibana
systemctl start kibana

# Verify Kibana is running
curl -I localhost:5601
systemctl status kibana
```

### 4. Install and Configure Heartbeat

```bash
# Install Heartbeat
apt install -y heartbeat-elastic=8.15.3
```

Configure Heartbeat in `/etc/heartbeat/heartbeat.yml`:
```yaml
heartbeat.monitors:
- type: http
  id: cms-http
  name: CMS Website
  schedule: '@every 10s'
  urls: ["http://10.114.0.2"]
  
- type: tcp
  id: mysql-tcp
  name: MySQL Database
  schedule: '@every 10s'
  hosts: ["10.114.0.2:3306"]

output.elasticsearch:
  hosts: ["localhost:9200"]
```

Start Heartbeat:
```bash
systemctl enable heartbeat-elastic
systemctl start heartbeat-elastic

# Verify Heartbeat is running
systemctl status heartbeat-elastic
```

## CMS Server Setup

### 1. Install LEMP Stack

```bash
# Update system
apt update
apt upgrade -y

# Install NGINX, MySQL, PHP-FPM
apt install -y nginx mysql-server php-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip

# Verify installations
nginx -v
mysql --version
php-fpm8.3 -v
```

### 2. Configure MySQL

```bash
# Secure MySQL installation
mysql_secure_installation

# Create database and user
mysql -u root -p
CREATE DATABASE cmsdb;
CREATE USER 'cmsuser'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON cmsdb.* TO 'cmsuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# Verify MySQL connection
mysql -u cmsuser -p cmsdb
```

### 3. Configure NGINX

Create/edit `/etc/nginx/sites-available/default`:
```nginx
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/html;
    index index.php index.html index.htm;
    server_name _;

    # Add status page for metrics
    location /nginx_status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
```

Verify and restart NGINX:
```bash
nginx -t
systemctl restart nginx
```

### 4. Install and Configure Filebeat

```bash
# Install Filebeat
curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.15.3-amd64.deb
dpkg -i filebeat-8.15.3-amd64.deb
```

Configure Filebeat in `/etc/filebeat/filebeat.yml`:
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  processors:
    - dissect:
        tokenizer: "%{client_ip} - %{user} [%{timestamp}] \"%{method} %{request} HTTP/%{httpversion}\" %{status_code} %{size} \"%{referrer}\" \"%{agent}\""
        field: "message"
        target_prefix: "nginx"

- type: log
  enabled: true
  paths:
    - /var/log/mysql/error.log
    - /var/log/mysql/mysql-slow.log
  tags: ["mysql"]

- type: log
  enabled: true
  paths:
    - /var/log/php*/*.log
  tags: ["php-fpm"]

output.elasticsearch:
  hosts: ["ELK_SERVER_IP:9200"]
```

### 5. Install and Configure Metricbeat

```bash
# Install Metricbeat
curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.15.3-amd64.deb
dpkg -i metricbeat-8.15.3-amd64.deb
```

Configure Metricbeat in `/etc/metricbeat/metricbeat.yml`:
```yaml
metricbeat.modules:
- module: system
  metricsets:
    - cpu
    - load
    - memory
    - network
    - process
  enabled: true
  period: 10s

- module: nginx
  metricsets: ["stubstatus"]
  enabled: true
  period: 10s
  hosts: ["http://localhost/nginx_status"]

- module: mysql
  metricsets: ["status", "performance"]
  enabled: true
  period: 10s
  hosts: ["tcp(localhost:3306)/"]
  username: root
  password: ${MYSQL_ROOT_PASSWORD}

output.elasticsearch:
  hosts: ["10.114.0.3:9200"]
```

Start and verify Beats:
```bash
# Start services
systemctl enable filebeat metricbeat
systemctl start filebeat metricbeat

# Verify both are running
systemctl status filebeat
systemctl status metricbeat
```

## Firewall Configuration

Configure the DigitalOcean firewall rules:

### ELK Server
- Allow SSH (22) from your IP
- Allow Elasticsearch (9200) from CMS Server IP
- Allow Kibana (5601) from your IP

### CMS Server
- Allow SSH (22) from your IP
- Allow HTTP (80) from anywhere
- Allow MySQL (3306) from ELK Server IP

## Verification Steps

1. Verify Elasticsearch:
```bash
# Check cluster health
curl localhost:9200/_cat/health

# Check indices
curl localhost:9200/_cat/indices
```

2. Verify Kibana:
```bash
# Check Kibana status
curl -I localhost:5601

# Access web interface
http://ELK_SERVER_IP:5601
```

3. Verify Beats:
```bash
# Check if data is being received
curl localhost:9200/_cat/indices/filebeat-*
curl localhost:9200/_cat/indices/metricbeat-*
```

4. Verify LEMP Stack:
```bash
# Check NGINX
systemctl status nginx
curl localhost

# Check MySQL
mysql -V
systemctl status mysql

# Check PHP-FPM
php-fpm8.1 -v
systemctl status php8.1-fpm
```

## Troubleshooting

### Elasticsearch Issues
```bash
# Check logs
journalctl -u elasticsearch

# Check cluster health
curl localhost:9200/_cluster/health

# Common issues:
# 1. Memory - check settings in jvm.options
# 2. Permissions - ensure correct ownership of directories
# 3. Port conflicts - ensure nothing else uses port 9200
```

### Kibana Issues
```bash
# Check logs
journalctl -u kibana

# Common issues:
# 1. Connection to Elasticsearch - verify elasticsearch.hosts
# 2. Memory - adjust NODE_OPTIONS in service file
# 3. Permissions - check ownership of directories
```

### Beats Issues
```bash
# Check Filebeat logs
journalctl -u filebeat

# Check Metricbeat logs
journalctl -u metricbeat

# Test Elasticsearch connection
curl ELK_SERVER_IP:9200

# Common issues:
# 1. Connection refused - check firewall rules
# 2. Permission denied - check log file permissions
# 3. Configuration errors - validate yaml syntax
```

### LEMP Stack Issues
```bash
# Check NGINX logs
tail -f /var/log/nginx/error.log

# Check PHP-FPM logs
tail -f /var/log/php8.1-fpm.log

# Check MySQL logs
tail -f /var/log/mysql/error.log
```
